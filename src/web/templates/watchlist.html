{% extends "base.html" %}

{% block title %}Watchlist - Simkl to Letterboxd{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
        <h1 class="text-xl font-semibold" data-i18n="watchlist.title">Watchlist</h1>
        <span id="watchlist-count" class="text-zinc-500"></span>
    </div>
    <div class="flex items-center gap-3">
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" id="search-input" data-i18n-placeholder="watchlist.search" placeholder="Search..." class="input pl-9 w-48">
        </div>
        <a href="/api/export/csv?watched=false&watchlist=true" class="btn btn-ghost" data-i18n="watchlist.export">Export</a>
    </div>
</div>

<!-- Grid -->
<div id="movies-grid" class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));"></div>

<div id="loading" class="hidden text-center py-12 text-zinc-500">
    <div class="spinner mx-auto mb-2"></div>
    <span data-i18n="watchlist.loading">Loading...</span>
</div>

<div id="empty-state" class="hidden text-center py-20 text-zinc-500">
    <div class="text-4xl mb-3">ðŸŽ¬</div>
    <div data-i18n="watchlist.empty">Your watchlist is empty</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const iconLB = `<svg viewBox="0 0 500 500" fill="white"><path d="M250 500C111.93 500 0 388.07 0 250S111.93 0 250 0s250 111.93 250 250-111.93 250-250 250zm0-425c-96.52 0-175 78.48-175 175s78.48 175 175 175 175-78.48 175-175-78.48-175-175-175z"/><circle cx="250" cy="250" r="100" fill="white"/></svg>`;
    const iconIMDb = `<svg viewBox="0 0 448 512" fill="#000"><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM68.5 256V150.2h41.7V256H68.5zm113.1 0h-36.3V150.2h36.3c20.3 0 36.7 16.5 36.7 36.7v32.4c0 20.2-16.4 36.7-36.7 36.7zm148.7 0h-38.9l-14.4-63.5L262.5 256h-38.9V150.2h32.4v64.6l18-64.6h25.7l18 64.6v-64.6h32.4V256z"/></svg>`;
    const iconTMDB = `<svg viewBox="0 0 185 133" fill="white"><path d="M92.5 0C41.4 0 0 29.8 0 66.5S41.4 133 92.5 133 185 103.2 185 66.5 143.6 0 92.5 0zm0 110c-35.9 0-65-19.5-65-43.5S56.6 23 92.5 23s65 19.5 65 43.5-29.1 43.5-65 43.5z"/></svg>`;

    async function loadMovies() {
        const search = document.getElementById('search-input').value;
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('movies-grid').innerHTML = '';
        document.getElementById('empty-state').classList.add('hidden');

        const params = new URLSearchParams({ watched: 'false', watchlist: 'true', limit: 200 });
        if (search) params.set('search', search);

        try {
            const res = await fetch(`/api/movies?${params}`);
            const data = await res.json();

            document.getElementById('watchlist-count').textContent = `(${data.movies.length})`;

            if (data.movies.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('movies-grid').innerHTML = data.movies.map(m => {
                    const poster = m.poster_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2 3"><rect fill="%2318181b"/></svg>';
                    return `
                        <div class="cursor-pointer group">
                            <div class="poster aspect-[2/3] mb-1.5">
                                <img src="${poster}" alt="${m.title}" class="w-full h-full object-cover" loading="lazy">
                                <div class="poster-info">
                                    <div class="flex gap-1">
                                        ${m.letterboxd_url ? `<a href="${m.letterboxd_url}" target="_blank" class="icon-link icon-lb" title="Letterboxd">${iconLB}</a>` : ''}
                                        ${m.imdb_url ? `<a href="${m.imdb_url}" target="_blank" class="icon-link icon-imdb" title="IMDb">${iconIMDb}</a>` : ''}
                                        ${m.tmdb_url ? `<a href="${m.tmdb_url}" target="_blank" class="icon-link icon-tmdb" title="TMDB">${iconTMDB}</a>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs font-medium truncate text-zinc-300 group-hover:text-white">${m.title}</div>
                            <div class="text-xs text-zinc-600">${m.year || ''}</div>
                        </div>
                    `;
                }).join('');
            }
        } catch (e) {
            showToast(t('watchlist.load_failed'));
        }

        document.getElementById('loading').classList.add('hidden');
    }

    let timeout;
    document.getElementById('search-input').addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(loadMovies, 300);
    });

    loadMovies();
</script>
{% endblock %}
