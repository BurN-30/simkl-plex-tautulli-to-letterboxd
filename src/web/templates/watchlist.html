{% extends "base.html" %}

{% block title %}Watchlist - Simkl to Letterboxd{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
        <h1 class="text-xl font-semibold" data-i18n="watchlist.title">Watchlist</h1>
        <span id="watchlist-count" class="text-zinc-500"></span>
    </div>
    <div class="flex items-center gap-3">
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" id="search-input" data-i18n-placeholder="watchlist.search" placeholder="Search..." class="input pl-9 w-48">
        </div>
        <a href="/api/export/csv?watched=false&watchlist=true" class="btn btn-ghost" data-i18n="watchlist.export">Export</a>
    </div>
</div>

<!-- Grid -->
<div id="movies-grid" class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));"></div>

<div id="loading" class="hidden text-center py-12 text-zinc-500">
    <div class="spinner mx-auto mb-2"></div>
    <span data-i18n="watchlist.loading">Loading...</span>
</div>

<div id="empty-state" class="hidden text-center py-20 text-zinc-500">
    <div class="text-4xl mb-3">ðŸŽ¬</div>
    <div data-i18n="watchlist.empty">Your watchlist is empty</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const iconLB = `<svg viewBox="0 0 100 100"><g transform="translate(0,31.5) scale(.2646)"><ellipse fill="#FF8000" cx="70" cy="70" rx="70" ry="70"/><ellipse fill="#00E054" cx="189" cy="70" rx="70" ry="70"/><ellipse fill="#40BCF4" cx="308" cy="70" rx="70" ry="70"/></g></svg>`;
    const iconIMDb = `<svg viewBox="0 0 250 250"><path fill="#161616" fill-rule="evenodd" d="M48.5,85.8v77.4h-20v-77.4h20ZM91.1,85.8l-4.6,36.2-2.9-19.7c-.9-6.3-1.6-11.8-2.4-16.5h-25.9v77.4h17.5v-51.1c0,0,7.4,51.1,7.4,51.1h12.5l7-52.2v52.2h17.5v-77.4h-26.1ZM148.2,163.2c4.8,0,8.4-.3,10.8-.8,2.4-.5,4.4-1.4,6-2.8,1.6-1.3,2.8-3.1,3.4-5.5.6-2.4,1.1-7,1.1-13.9v-27.1c0-7.3-.3-12.3-.8-14.7-.4-2.5-1.5-4.8-3.3-6.8-1.8-2.1-4.4-3.5-7.8-4.4-3.3-.8-9-1.3-18.6-1.3h-15v77.4h24.2ZM144,99.1v50.8c2.8,0,4.6-.6,5.3-1.8.6-1.1,1-4.3,1-9.4v-30c0-3.5,0-5.8-.4-6.8-.2-1-.7-1.7-1.5-2.1-.8-.5-2.3-.7-4.4-.7ZM176.2,85.8v77.4h18l1.2-4.9c1.6,2,3.4,3.5,5.4,4.5,1.9.9,4.8,1.4,7.1,1.4s5.9-.8,8.2-2.5c2.3-1.6,3.8-3.6,4.4-5.9.6-2.3.9-5.7.9-10.3v-21.7c0-4.6-.1-7.7-.4-9.1-.2-1.4-.8-2.9-1.8-4.4-1.1-1.5-2.6-2.6-4.5-3.5-1.9-.8-4.2-1.2-6.9-1.2s-5.2.5-7.2,1.4c-1.9.9-3.7,2.3-5.3,4.2v-25.2h-19.2ZM202.2,124.6c0-3.2-.2-5.3-.6-6.3-.4-1.1-2.1-1.5-3.3-1.5s-1.9.4-2.3,1.3c-.4.9-.6,3.1-.6,6.6v20.5c0,3.4.2,5.6.6,6.6.4.9,1.2,1.4,2.3,1.4s2.9-.5,3.2-1.5c.4-1,.6-3.3.6-7v-19.9Z"/></svg>`;
    const iconTMDB = `<svg viewBox="0 0 185.04 133.4"><path fill="url(#tmdb-grad)" d="M51.06,66.7h0A17.67,17.67,0,0,1,68.73,49h-.1A17.67,17.67,0,0,1,86.3,66.7h0A17.67,17.67,0,0,1,68.63,84.37h.1A17.67,17.67,0,0,1,51.06,66.7Zm82.67-31.33h32.9A17.67,17.67,0,0,0,184.3,17.7h0A17.67,17.67,0,0,0,166.63,0h-32.9A17.67,17.67,0,0,0,116.06,17.7h0A17.67,17.67,0,0,0,133.73,35.37Zm-113,98h63.9A17.67,17.67,0,0,0,102.3,115.7h0A17.67,17.67,0,0,0,84.63,98H20.73A17.67,17.67,0,0,0,3.06,115.7h0A17.67,17.67,0,0,0,20.73,133.37Z"/></svg>`;

    async function loadMovies() {
        const search = document.getElementById('search-input').value;
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('movies-grid').innerHTML = '';
        document.getElementById('empty-state').classList.add('hidden');

        const params = new URLSearchParams({ watched: 'false', watchlist: 'true', limit: 200 });
        if (search) params.set('search', search);

        try {
            const res = await fetch(`/api/movies?${params}`);
            const data = await res.json();

            document.getElementById('watchlist-count').textContent = `(${data.movies.length})`;

            if (data.movies.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('movies-grid').innerHTML = data.movies.map(m => {
                    const poster = m.poster_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2 3"><rect fill="%2318181b"/></svg>';
                    return `
                        <div class="cursor-pointer group">
                            <div class="poster aspect-[2/3] mb-1.5">
                                <img src="${poster}" alt="${m.title}" class="w-full h-full object-cover" loading="lazy">
                                <div class="poster-info">
                                    <div class="flex gap-1">
                                        ${m.letterboxd_url ? `<a href="${m.letterboxd_url}" target="_blank" class="icon-link icon-lb" title="Letterboxd">${iconLB}</a>` : ''}
                                        ${m.imdb_url ? `<a href="${m.imdb_url}" target="_blank" class="icon-link icon-imdb" title="IMDb">${iconIMDb}</a>` : ''}
                                        ${m.tmdb_url ? `<a href="${m.tmdb_url}" target="_blank" class="icon-link icon-tmdb" title="TMDB">${iconTMDB}</a>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs font-medium truncate text-zinc-300 group-hover:text-white">${m.title}</div>
                            <div class="text-xs text-zinc-600">${m.year || ''}</div>
                        </div>
                    `;
                }).join('');
            }
        } catch (e) {
            showToast(t('watchlist.load_failed'));
        }

        document.getElementById('loading').classList.add('hidden');
    }

    let timeout;
    document.getElementById('search-input').addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(loadMovies, 300);
    });

    loadMovies();
</script>
{% endblock %}
