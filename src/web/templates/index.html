{% extends "base.html" %}

{% block title %}Films - Letterboxd Sync{% endblock %}

{% block content %}
<!-- Stats + Filters Bar -->
<div class="flex flex-wrap items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-6">
        <div class="flex items-center gap-2">
            <span class="text-2xl font-bold">{{ stats.total_watched }}</span>
            <span class="text-zinc-500 text-sm" data-i18n="index.films">films</span>
        </div>
        <div class="w-px h-6 divider"></div>
        <div class="flex items-center gap-2">
            <span class="text-xl font-semibold text-amber-400">{{ stats.average_rating }}</span>
            <span class="text-zinc-500 text-sm" data-i18n="index.avg">avg</span>
        </div>
        <div class="w-px h-6 divider"></div>
        <div class="flex items-center gap-2">
            <span class="text-xl font-semibold text-zinc-400">{{ stats.total_watchlist }}</span>
            <span class="text-zinc-500 text-sm" data-i18n="index.watchlist">watchlist</span>
        </div>
    </div>

    <div class="flex items-center gap-3">
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" id="search-input" data-i18n-placeholder="index.search" placeholder="Search..." class="input pl-9 w-48">
        </div>
        <select id="year-filter" class="input">
            <option value="" data-i18n="index.year">Year</option>
            {% for year in years %}<option value="{{ year }}">{{ year }}</option>{% endfor %}
        </select>
        <select id="rating-filter" class="input">
            <option value="" data-i18n="index.rating">Rating</option>
            <option value="5">5★</option>
            <option value="4">4★+</option>
            <option value="3">3★+</option>
        </select>
        <select id="sort-select" class="input">
            <option value="watched_date-desc" data-i18n="index.sort_recent">Recent</option>
            <option value="rating-desc" data-i18n="index.sort_top">Top Rated</option>
            <option value="year-desc" data-i18n="index.sort_newest">Newest</option>
            <option value="title-asc" data-i18n="index.sort_az">A-Z</option>
        </select>
    </div>
</div>

<!-- Recently Watched -->
<section class="mb-8">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wide" data-i18n="index.recently_watched">Recently Watched</h2>
        <div class="flex gap-1">
            <button onclick="scrollCarousel('recent', -1)" class="p-1.5 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button onclick="scrollCarousel('recent', 1)" class="p-1.5 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>
    </div>
    <div id="recent-carousel" class="carousel flex gap-3"></div>
</section>

<!-- Top Rated -->
<section class="mb-8">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wide" data-i18n="index.top_rated">Top Rated</h2>
        <div class="flex gap-1">
            <button onclick="scrollCarousel('toprated', -1)" class="p-1.5 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button onclick="scrollCarousel('toprated', 1)" class="p-1.5 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>
    </div>
    <div id="toprated-carousel" class="carousel flex gap-3"></div>
</section>

<!-- All Films Grid -->
<section>
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wide"><span data-i18n="index.all_films">All Films</span> <span id="movies-count" class="text-zinc-600"></span></h2>
    </div>
    <div id="movies-grid" class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));"></div>
    <div id="loading" class="hidden text-center py-10 text-zinc-500"><div class="spinner mx-auto"></div></div>
</section>
{% endblock %}

{% block scripts %}
<script>
    let allMovies = [];

    function scrollCarousel(id, dir) {
        document.getElementById(id + '-carousel').scrollBy({ left: dir * 250, behavior: 'smooth' });
    }

    function formatDate(d) {
        if (!d) return '';
        const date = new Date(d + 'T00:00:00');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        return date.getDate() + ' ' + t('month.' + month);
    }

    function stars(r) {
        if (!r) return '';
        return '★'.repeat(Math.floor(r)) + (r % 1 >= 0.5 ? '½' : '');
    }

    // Icons SVG — officiels depuis letterboxd.com/about/brand/ et themoviedb.org/about/logos-attribution
    const iconLB = `<svg viewBox="0 0 100 100"><g transform="translate(0,31.5) scale(.2646)"><ellipse fill="#FF8000" cx="70" cy="70" rx="70" ry="70"/><ellipse fill="#00E054" cx="189" cy="70" rx="70" ry="70"/><ellipse fill="#40BCF4" cx="308" cy="70" rx="70" ry="70"/></g></svg>`;
    const iconIMDb = `<svg viewBox="0 0 250 250"><path fill="#161616" fill-rule="evenodd" d="M48.5,85.8v77.4h-20v-77.4h20ZM91.1,85.8l-4.6,36.2-2.9-19.7c-.9-6.3-1.6-11.8-2.4-16.5h-25.9v77.4h17.5v-51.1c0,0,7.4,51.1,7.4,51.1h12.5l7-52.2v52.2h17.5v-77.4h-26.1ZM148.2,163.2c4.8,0,8.4-.3,10.8-.8,2.4-.5,4.4-1.4,6-2.8,1.6-1.3,2.8-3.1,3.4-5.5.6-2.4,1.1-7,1.1-13.9v-27.1c0-7.3-.3-12.3-.8-14.7-.4-2.5-1.5-4.8-3.3-6.8-1.8-2.1-4.4-3.5-7.8-4.4-3.3-.8-9-1.3-18.6-1.3h-15v77.4h24.2ZM144,99.1v50.8c2.8,0,4.6-.6,5.3-1.8.6-1.1,1-4.3,1-9.4v-30c0-3.5,0-5.8-.4-6.8-.2-1-.7-1.7-1.5-2.1-.8-.5-2.3-.7-4.4-.7ZM176.2,85.8v77.4h18l1.2-4.9c1.6,2,3.4,3.5,5.4,4.5,1.9.9,4.8,1.4,7.1,1.4s5.9-.8,8.2-2.5c2.3-1.6,3.8-3.6,4.4-5.9.6-2.3.9-5.7.9-10.3v-21.7c0-4.6-.1-7.7-.4-9.1-.2-1.4-.8-2.9-1.8-4.4-1.1-1.5-2.6-2.6-4.5-3.5-1.9-.8-4.2-1.2-6.9-1.2s-5.2.5-7.2,1.4c-1.9.9-3.7,2.3-5.3,4.2v-25.2h-19.2ZM202.2,124.6c0-3.2-.2-5.3-.6-6.3-.4-1.1-2.1-1.5-3.3-1.5s-1.9.4-2.3,1.3c-.4.9-.6,3.1-.6,6.6v20.5c0,3.4.2,5.6.6,6.6.4.9,1.2,1.4,2.3,1.4s2.9-.5,3.2-1.5c.4-1,.6-3.3.6-7v-19.9Z"/></svg>`;
    const iconTMDB = `<svg viewBox="0 0 185.04 133.4"><path fill="url(#tmdb-grad)" d="M51.06,66.7h0A17.67,17.67,0,0,1,68.73,49h-.1A17.67,17.67,0,0,1,86.3,66.7h0A17.67,17.67,0,0,1,68.63,84.37h.1A17.67,17.67,0,0,1,51.06,66.7Zm82.67-31.33h32.9A17.67,17.67,0,0,0,184.3,17.7h0A17.67,17.67,0,0,0,166.63,0h-32.9A17.67,17.67,0,0,0,116.06,17.7h0A17.67,17.67,0,0,0,133.73,35.37Zm-113,98h63.9A17.67,17.67,0,0,0,102.3,115.7h0A17.67,17.67,0,0,0,84.63,98H20.73A17.67,17.67,0,0,0,3.06,115.7h0A17.67,17.67,0,0,0,20.73,133.37Z"/></svg>`;

    function movieCard(m, w = 'w-32') {
        const poster = m.poster_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2 3"><rect fill="%2318181b"/></svg>';
        return `
            <div class="carousel-item ${w} cursor-pointer" onclick='openEditModal(${JSON.stringify(m).replace(/'/g, "\\'")})'>
                <div class="poster aspect-[2/3] mb-1.5">
                    <img src="${poster}" alt="${m.title}" class="w-full h-full object-cover" loading="lazy">
                    <div class="poster-info">
                        ${m.rating ? `<div class="stars text-sm mb-1">${stars(m.rating)}</div>` : ''}
                        <div class="flex gap-1">
                            ${m.letterboxd_url ? `<a href="${m.letterboxd_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-lb" title="Letterboxd">${iconLB}</a>` : ''}
                            ${m.imdb_url ? `<a href="${m.imdb_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-imdb" title="IMDb">${iconIMDb}</a>` : ''}
                            ${m.tmdb_url ? `<a href="${m.tmdb_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-tmdb" title="TMDB">${iconTMDB}</a>` : ''}
                        </div>
                    </div>
                </div>
                <div class="text-xs font-medium truncate text-zinc-200">${m.title}</div>
                <div class="text-xs text-zinc-500">${m.year || ''}${m.watched_date ? ' · ' + formatDate(m.watched_date) : ''}</div>
            </div>
        `;
    }

    function gridCard(m) {
        const poster = m.poster_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2 3"><rect fill="%2318181b"/></svg>';
        return `
            <div class="cursor-pointer group" onclick='openEditModal(${JSON.stringify(m).replace(/'/g, "\\'")})'>
                <div class="poster aspect-[2/3] mb-1.5">
                    <img src="${poster}" alt="${m.title}" class="w-full h-full object-cover" loading="lazy">
                    <div class="poster-info">
                        ${m.rating ? `<div class="stars text-xs">${stars(m.rating)}</div>` : ''}
                        <div class="flex gap-1 mt-1">
                            ${m.letterboxd_url ? `<a href="${m.letterboxd_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-lb" title="Letterboxd">${iconLB}</a>` : ''}
                            ${m.imdb_url ? `<a href="${m.imdb_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-imdb" title="IMDb">${iconIMDb}</a>` : ''}
                            ${m.tmdb_url ? `<a href="${m.tmdb_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-tmdb" title="TMDB">${iconTMDB}</a>` : ''}
                        </div>
                    </div>
                </div>
                <div class="text-xs font-medium truncate text-zinc-300 group-hover:text-white">${m.title}</div>
                <div class="text-xs text-zinc-600">${m.year || ''}${m.watched_date ? ' · ' + formatDate(m.watched_date) : ''}</div>
            </div>
        `;
    }

    async function loadMovies() {
        document.getElementById('loading').classList.remove('hidden');

        const params = new URLSearchParams({
            watched: 'true',
            limit: 100,
            sort_by: document.getElementById('sort-select').value.split('-')[0],
            sort_order: document.getElementById('sort-select').value.split('-')[1],
        });

        const search = document.getElementById('search-input').value;
        const year = document.getElementById('year-filter').value;
        const rating = document.getElementById('rating-filter').value;
        if (search) params.set('search', search);
        if (year) params.set('year', year);
        if (rating) params.set('min_rating', rating);

        try {
            const res = await fetch(`/api/movies?${params}`);
            const data = await res.json();
            allMovies = data.movies;
            document.getElementById('movies-count').textContent = `(${data.total})`;
            render();
        } catch (e) {
            showToast(t('index.load_failed'));
        }

        document.getElementById('loading').classList.add('hidden');
    }

    function render() {
        // Recent - show more items on larger screens
        const recent = [...allMovies].sort((a, b) => (b.watched_date || '').localeCompare(a.watched_date || '')).slice(0, 20);
        document.getElementById('recent-carousel').innerHTML = recent.map(m => movieCard(m, 'w-36')).join('');

        // Top rated
        const top = [...allMovies].filter(m => m.rating >= 4).sort((a, b) => (b.rating || 0) - (a.rating || 0)).slice(0, 20);
        document.getElementById('toprated-carousel').innerHTML = top.map(m => movieCard(m, 'w-36')).join('');

        // Grid
        document.getElementById('movies-grid').innerHTML = allMovies.map(gridCard).join('');
    }

    // Events
    let timeout;
    document.getElementById('search-input').addEventListener('input', () => { clearTimeout(timeout); timeout = setTimeout(loadMovies, 300); });
    ['year-filter', 'rating-filter', 'sort-select'].forEach(id => document.getElementById(id).addEventListener('change', loadMovies));

    loadMovies();
</script>
{% endblock %}
