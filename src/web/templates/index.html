{% extends "base.html" %}

{% block title %}Films - Letterboxd Sync{% endblock %}

{% block content %}
<!-- Stats + Filters Bar -->
<div class="flex flex-wrap items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-6">
        <div class="flex items-center gap-2">
            <span class="text-2xl font-bold">{{ stats.total_watched }}</span>
            <span class="text-zinc-500 text-sm" data-i18n="index.films">films</span>
        </div>
        <div class="w-px h-6 divider"></div>
        <div class="flex items-center gap-2">
            <span class="text-xl font-semibold text-amber-400">{{ stats.average_rating }}</span>
            <span class="text-zinc-500 text-sm" data-i18n="index.avg">avg</span>
        </div>
        <div class="w-px h-6 divider"></div>
        <div class="flex items-center gap-2">
            <span class="text-xl font-semibold text-zinc-400">{{ stats.total_watchlist }}</span>
            <span class="text-zinc-500 text-sm" data-i18n="index.watchlist">watchlist</span>
        </div>
    </div>

    <div class="flex items-center gap-3">
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" id="search-input" data-i18n-placeholder="index.search" placeholder="Search..." class="input pl-9 w-48">
        </div>
        <select id="year-filter" class="input">
            <option value="" data-i18n="index.year">Year</option>
            {% for year in years %}<option value="{{ year }}">{{ year }}</option>{% endfor %}
        </select>
        <select id="rating-filter" class="input">
            <option value="" data-i18n="index.rating">Rating</option>
            <option value="5">5★</option>
            <option value="4">4★+</option>
            <option value="3">3★+</option>
        </select>
        <select id="sort-select" class="input">
            <option value="watched_date-desc" data-i18n="index.sort_recent">Recent</option>
            <option value="rating-desc" data-i18n="index.sort_top">Top Rated</option>
            <option value="year-desc" data-i18n="index.sort_newest">Newest</option>
            <option value="title-asc" data-i18n="index.sort_az">A-Z</option>
        </select>
    </div>
</div>

<!-- Recently Watched -->
<section class="mb-8">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wide" data-i18n="index.recently_watched">Recently Watched</h2>
        <div class="flex gap-1">
            <button onclick="scrollCarousel('recent', -1)" class="p-1.5 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button onclick="scrollCarousel('recent', 1)" class="p-1.5 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>
    </div>
    <div id="recent-carousel" class="carousel flex gap-3"></div>
</section>

<!-- Top Rated -->
<section class="mb-8">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wide" data-i18n="index.top_rated">Top Rated</h2>
        <div class="flex gap-1">
            <button onclick="scrollCarousel('toprated', -1)" class="p-1.5 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button onclick="scrollCarousel('toprated', 1)" class="p-1.5 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>
    </div>
    <div id="toprated-carousel" class="carousel flex gap-3"></div>
</section>

<!-- All Films Grid -->
<section>
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wide"><span data-i18n="index.all_films">All Films</span> <span id="movies-count" class="text-zinc-600"></span></h2>
    </div>
    <div id="movies-grid" class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));"></div>
    <div id="loading" class="hidden text-center py-10 text-zinc-500"><div class="spinner mx-auto"></div></div>
</section>
{% endblock %}

{% block scripts %}
<script>
    let allMovies = [];

    function scrollCarousel(id, dir) {
        document.getElementById(id + '-carousel').scrollBy({ left: dir * 250, behavior: 'smooth' });
    }

    function formatDate(d) {
        if (!d) return '';
        const date = new Date(d + 'T00:00:00');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        return date.getDate() + ' ' + t('month.' + month);
    }

    function stars(r) {
        if (!r) return '';
        return '★'.repeat(Math.floor(r)) + (r % 1 >= 0.5 ? '½' : '');
    }

    // Icons SVG
    const iconLB = `<svg viewBox="0 0 500 500" fill="white"><path d="M250 500C111.93 500 0 388.07 0 250S111.93 0 250 0s250 111.93 250 250-111.93 250-250 250zm0-425c-96.52 0-175 78.48-175 175s78.48 175 175 175 175-78.48 175-175-78.48-175-175-175z"/><circle cx="250" cy="250" r="100" fill="white"/></svg>`;
    const iconIMDb = `<svg viewBox="0 0 448 512" fill="#000"><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM68.5 256V150.2h41.7V256H68.5zm113.1 0h-36.3V150.2h36.3c20.3 0 36.7 16.5 36.7 36.7v32.4c0 20.2-16.4 36.7-36.7 36.7zm148.7 0h-38.9l-14.4-63.5L262.5 256h-38.9V150.2h32.4v64.6l18-64.6h25.7l18 64.6v-64.6h32.4V256z"/></svg>`;
    const iconTMDB = `<svg viewBox="0 0 185 133" fill="white"><path d="M92.5 0C41.4 0 0 29.8 0 66.5S41.4 133 92.5 133 185 103.2 185 66.5 143.6 0 92.5 0zm0 110c-35.9 0-65-19.5-65-43.5S56.6 23 92.5 23s65 19.5 65 43.5-29.1 43.5-65 43.5z"/></svg>`;

    function movieCard(m, w = 'w-32') {
        const poster = m.poster_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2 3"><rect fill="%2318181b"/></svg>';
        return `
            <div class="carousel-item ${w} cursor-pointer" onclick='openEditModal(${JSON.stringify(m).replace(/'/g, "\\'")})'>
                <div class="poster aspect-[2/3] mb-1.5">
                    <img src="${poster}" alt="${m.title}" class="w-full h-full object-cover" loading="lazy">
                    <div class="poster-info">
                        ${m.rating ? `<div class="stars text-sm mb-1">${stars(m.rating)}</div>` : ''}
                        <div class="flex gap-1">
                            ${m.letterboxd_url ? `<a href="${m.letterboxd_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-lb" title="Letterboxd">${iconLB}</a>` : ''}
                            ${m.imdb_url ? `<a href="${m.imdb_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-imdb" title="IMDb">${iconIMDb}</a>` : ''}
                            ${m.tmdb_url ? `<a href="${m.tmdb_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-tmdb" title="TMDB">${iconTMDB}</a>` : ''}
                        </div>
                    </div>
                </div>
                <div class="text-xs font-medium truncate text-zinc-200">${m.title}</div>
                <div class="text-xs text-zinc-500">${m.year || ''}${m.watched_date ? ' · ' + formatDate(m.watched_date) : ''}</div>
            </div>
        `;
    }

    function gridCard(m) {
        const poster = m.poster_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2 3"><rect fill="%2318181b"/></svg>';
        return `
            <div class="cursor-pointer group" onclick='openEditModal(${JSON.stringify(m).replace(/'/g, "\\'")})'>
                <div class="poster aspect-[2/3] mb-1.5">
                    <img src="${poster}" alt="${m.title}" class="w-full h-full object-cover" loading="lazy">
                    <div class="poster-info">
                        ${m.rating ? `<div class="stars text-xs">${stars(m.rating)}</div>` : ''}
                        <div class="flex gap-1 mt-1">
                            ${m.letterboxd_url ? `<a href="${m.letterboxd_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-lb" title="Letterboxd">${iconLB}</a>` : ''}
                            ${m.imdb_url ? `<a href="${m.imdb_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-imdb" title="IMDb">${iconIMDb}</a>` : ''}
                            ${m.tmdb_url ? `<a href="${m.tmdb_url}" target="_blank" onclick="event.stopPropagation()" class="icon-link icon-tmdb" title="TMDB">${iconTMDB}</a>` : ''}
                        </div>
                    </div>
                </div>
                <div class="text-xs font-medium truncate text-zinc-300 group-hover:text-white">${m.title}</div>
                <div class="text-xs text-zinc-600">${m.year || ''}${m.watched_date ? ' · ' + formatDate(m.watched_date) : ''}</div>
            </div>
        `;
    }

    async function loadMovies() {
        document.getElementById('loading').classList.remove('hidden');

        const params = new URLSearchParams({
            watched: 'true',
            limit: 100,
            sort_by: document.getElementById('sort-select').value.split('-')[0],
            sort_order: document.getElementById('sort-select').value.split('-')[1],
        });

        const search = document.getElementById('search-input').value;
        const year = document.getElementById('year-filter').value;
        const rating = document.getElementById('rating-filter').value;
        if (search) params.set('search', search);
        if (year) params.set('year', year);
        if (rating) params.set('min_rating', rating);

        try {
            const res = await fetch(`/api/movies?${params}`);
            const data = await res.json();
            allMovies = data.movies;
            document.getElementById('movies-count').textContent = `(${data.total})`;
            render();
        } catch (e) {
            showToast(t('index.load_failed'));
        }

        document.getElementById('loading').classList.add('hidden');
    }

    function render() {
        // Recent - show more items on larger screens
        const recent = [...allMovies].sort((a, b) => (b.watched_date || '').localeCompare(a.watched_date || '')).slice(0, 20);
        document.getElementById('recent-carousel').innerHTML = recent.map(m => movieCard(m, 'w-36')).join('');

        // Top rated
        const top = [...allMovies].filter(m => m.rating >= 4).sort((a, b) => (b.rating || 0) - (a.rating || 0)).slice(0, 20);
        document.getElementById('toprated-carousel').innerHTML = top.map(m => movieCard(m, 'w-36')).join('');

        // Grid
        document.getElementById('movies-grid').innerHTML = allMovies.map(gridCard).join('');
    }

    // Events
    let timeout;
    document.getElementById('search-input').addEventListener('input', () => { clearTimeout(timeout); timeout = setTimeout(loadMovies, 300); });
    ['year-filter', 'rating-filter', 'sort-select'].forEach(id => document.getElementById(id).addEventListener('change', loadMovies));

    loadMovies();
</script>
{% endblock %}
